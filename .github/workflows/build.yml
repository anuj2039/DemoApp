name: CI
on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0  # Ensure you fetch the full history (important for some Buildozer use cases)

      # Set the date using environment files (replacing the deprecated 'set-output' command)
      - name: Get Date
        id: get-date
        run: echo "date=$(date -u '+%Y%m%d')" >> $GITHUB_ENV

      # Cache Buildozer global directory
      - name: Cache Buildozer global directory
        uses: actions/cache@v3
        with:
          path: ~/.buildozer  # Global directory for Buildozer
          key: buildozer-global-${{ hashFiles('DemoApp/buildozer.spec') }}

      # Cache Buildozer dependencies directory (specific to the DemoApp directory)
      - name: Cache Buildozer project build directory
        uses: actions/cache@v3
        with:
          path: DemoApp/.buildozer  # Project-specific build directory for DemoApp
          key: ${{ runner.os }}-${{ env.date }}-${{ hashFiles('DemoApp/buildozer.spec') }}

      # Navigate to the DemoApp directory and build the APK using Buildozer
      - name: Build APK with Buildozer
        run: |
          cd DemoApp
          buildozer android debug  # Build the APK

      # Upload artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: package
          path: DemoApp/bin/*.apk  # Replace with the actual path where Buildozer outputs the APK
